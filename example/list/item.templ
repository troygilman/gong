package main

import (
	"context"
	"fmt"
	"github.com/troygilman0/gong"
	"net/http"
	"strconv"
)

type itemHandler struct {
	db *userDatabase
}

func (handler itemHandler) Loader(ctx context.Context) any {
	name := gong.Param(ctx, "name")
	user, ok := handler.db.Read(name)
	if !ok {
		return nil
	}
	return user
}

templ (handler itemHandler) Action() {
	switch gong.Method(ctx) {
		case http.MethodDelete:
			{{
			name := gong.Param(ctx, "name")
			handler.db.Delete(name)
			}}
		case http.MethodPatch:
			{{
				name := gong.Param(ctx, "name")
				balance, err := strconv.Atoi(gong.Param(ctx, "balance"))
				if err != nil {
					panic(err)
				}
				handler.db.Update(userData{
					name:    name,
					balance: balance,
				})
			}}
			@handler.Component()
	}
}

templ (handler itemHandler) Component() {
	{{
	user := gong.UseLoaderData[userData](ctx)
	}}
	@gong.Target(
		gong.WithTargetID(user.name),
	) {
		{ user.name }
		@gong.Form(
			gong.WithFormMethod(http.MethodPatch),
			gong.WithFormID(user.name),
		) {
			<input type="hidden" name="name" value={ user.name }/>
			<input type="text" name="balance" value={ fmt.Sprintf("%d", user.balance) }/>
			<button type="submit">Update</button>
		}
		@gong.Form(
			gong.WithFormMethod(http.MethodDelete),
			gong.WithFormID(user.name),
		) {
			<input type="hidden" name="name" value={ user.name }/>
			<button type="submit">Delete</button>
		}
	}
}
